<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Say Tempo</title>
    <style>
        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: system-ui, -apple-system, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .container {
            text-align: center;
            padding: 2rem;
            background-color: #2a2a2a;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .tempo {
            font-size: 4rem;
            margin: 1rem 0;
            font-weight: bold;
            color: #4CAF50;
        }

        .controls {
            margin: 1rem 0;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 0.5rem;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }

        .status {
            margin-top: 1rem;
            color: #888;
        }

        .pulse {
            width: 20px;
            height: 20px;
            background-color: #4CAF50;
            border-radius: 50%;
            margin: 1rem auto;
            transition: transform 0.1s;
        }

        .pulse.active {
            transform: scale(1.5);
            background-color: #45a049;
        }

        .sound-selector {
            margin: 1rem 0;
            padding: 0.75rem;
            background-color: #333;
            border: none;
            border-radius: 0.5rem;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            width: 200px;
        }

        .sound-selector option {
            background-color: #333;
            color: white;
        }

        .listening-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin-left: 8px;
            border-radius: 50%;
            background-color: #4CAF50;
        }

        .listening-indicator.error {
            background-color: #f44336;
        }
    </style>
</head>

<body>
<div class="container">
    <h1>Say Tempo Metronome</h1>
    <div class="pulse" id="pulseIndicator"></div>
    <div class="tempo" id="tempoDisplay">80</div>
    <div>
        <label for="soundSelector"></label><select id="soundSelector" class="sound-selector">
        <option value="woodblock">Woodblock (Classic)</option>
        <option value="click">Digital Click</option>
        <option value="beep">High Beep</option>
        <option value="analog">Analog Tick</option>
        <option value="bell">Bell Tone</option>
    </select>
    </div>
    <div class="controls">
        <button id="startStop">Start</button>
    </div>
    <div class="status" id="status">Say a number between 10 and 400 <span id="listeningIndicator"
                                                                          class="listening-indicator"></span></div>
</div>

<script>
    class Metronome {
        constructor() {
            this.tempo = 80;
            this.everPlayed = false;
            this.isPlaying = false;
            this.audioContext = null;
            this.nextNoteTime = 0.0;
            this.timerID = null;
            this.pulseIndicator = document.getElementById('pulseIndicator');
            this.currentSound = 'woodblock';
            this.sounds = {
                woodblock: {
                    frequency: 880,
                    decay: 0.02,
                    Q: 10,
                    gain: 1
                },
                click: {
                    frequency: 2000,
                    decay: 0.005,
                    Q: 1,
                    gain: 0.7
                },
                beep: {
                    frequency: 1200,
                    decay: 0.1,
                    Q: 20,
                    gain: 0.6
                },
                analog: {
                    frequency: 600,
                    decay: 0.05,
                    Q: 4,
                    gain: 0.9
                },
                bell: {
                    frequency: 1500,
                    decay: 0.15,
                    Q: 30,
                    gain: 0.5
                }
            };

            // Load saved tempo and sound from localStorage
            const savedTempo = localStorage.getItem('metronomeTempo');
            const savedSound = localStorage.getItem('metronomeSoundName');

            if (savedTempo) {
                this.setTempo(parseInt(savedTempo));
            }

            if (savedSound && this.sounds[savedSound]) {
                this.setSound(savedSound);
            }
        }

        initAudioContext() {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        nextNote() {
            const secondsPerBeat = 60.0 / this.tempo;
            this.nextNoteTime += secondsPerBeat;
        }

        createSound(time) {
            const sound = this.sounds[this.currentSound];
            const osc = this.audioContext.createOscillator();
            const envelope = this.audioContext.createGain();
            const filter = this.audioContext.createBiquadFilter();

            osc.frequency.value = sound.frequency;

            filter.type = 'bandpass';
            filter.frequency.value = sound.frequency;
            filter.Q.value = sound.Q;

            envelope.gain.value = sound.gain;
            envelope.gain.exponentialRampToValueAtTime(sound.gain, time + 0.001);
            envelope.gain.exponentialRampToValueAtTime(0.001, time + sound.decay);

            osc.connect(filter);
            filter.connect(envelope);
            envelope.connect(this.audioContext.destination);

            return {
                start: () => osc.start(time),
                stop: () => osc.stop(time + sound.decay + 0.01)
            };
        }

        scheduleNote(time) {
            const note = this.createSound(time);
            note.start();
            note.stop();

            this.pulseIndicator.classList.add('active');
            setTimeout(() => {
                this.pulseIndicator.classList.remove('active');
            }, 100);
        }

        scheduler() {
            while (this.nextNoteTime < this.audioContext.currentTime + 0.1) {
                this.scheduleNote(this.nextNoteTime);
                this.nextNote();
            }
            this.timerID = window.setTimeout(() => this.scheduler(), 25.0);
        }

        start() {
            if (!this.audioContext) {
                this.initAudioContext();
            }

            if (this.isPlaying) return;

            this.isPlaying = true;
            this.everPlayed = true;
            this.nextNoteTime = this.audioContext.currentTime + 0.05;
            this.scheduler();
        }

        stop() {
            this.isPlaying = false;
            window.clearTimeout(this.timerID);
        }

        setTempo(newTempo) {
            this.tempo = Math.min(Math.max(newTempo, 10), 400);
            document.getElementById('tempoDisplay').textContent = this.tempo;
            localStorage.setItem('metronomeTempo', this.tempo);
        }

        setSound(soundName) {
            if (this.sounds[soundName]) {
                this.currentSound = soundName;
                if (!this.audioContext) {
                    this.initAudioContext();
                }

                if (!this.isPlaying) {
                    this.scheduleNote(this.audioContext.currentTime);
                }

                localStorage.setItem('metronomeSoundName', soundName);
            }
        }
    }

    // Initialize metronome
    const metronome = new Metronome();
    const startStopButton = document.getElementById('startStop');
    const soundSelector = document.getElementById('soundSelector');
    const statusElement = document.getElementById('status');
    const listeningIndicator = document.getElementById('listeningIndicator');

    // Initialize and start speech recognition
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;

    // Add a flag to check if recognition is active
    let isRecognitionActive = false;

    function startRecognition() {
        if (!isRecognitionActive) {
            recognition.start();
            listeningIndicator.classList.remove('error');
            isRecognitionActive = true;
        }
    }

    function startMetronome() {
        if (!metronome.isPlaying) {
            metronome.start();
            startStopButton.textContent = 'Stop';
            statusElement.textContent = 'Metronome started ';
            statusElement.appendChild(listeningIndicator);
        }
    }

    function stopMetronome() {
        if (metronome.isPlaying) {
            metronome.stop();
            startStopButton.textContent = 'Start';
            statusElement.textContent = 'Metronome stopped ';
            statusElement.appendChild(listeningIndicator);
        }
    }

    // Auto-start speech recognition when page loads
    window.addEventListener('load', () => {

        const tempoDisplay = document.getElementById('tempoDisplay');
        if (tempoDisplay) {
            tempoDisplay.textContent = metronome.tempo;
        }

        const soundSelector = document.getElementById('soundSelector');
        if (soundSelector) {
            soundSelector.value = metronome.currentSound;
        }

        startRecognition();
    });

    // Handle recognition restart on error
    recognition.addEventListener('end', () => {
        isRecognitionActive = false;
        startRecognition(); // Automatically restart recognition
    });

    recognition.addEventListener('error', (event) => {
        console.error('Speech recognition error detected: ' + event.error);
        isRecognitionActive = false;
        startRecognition();
    });

    startStopButton.addEventListener('click', () => {
        if (metronome.isPlaying) {
            stopMetronome();
        } else {
            startMetronome();
        }
    });

    soundSelector.addEventListener('change', (e) => {
        metronome.setSound(e.target.value);
    });

    recognition.onresult = (event) => {
        const result = event.results[event.results.length - 1];
        if (result.isFinal) {
            const transcript = result[0].transcript.trim().toLowerCase();

            if (transcript === 'start') {
                if (!metronome.isPlaying && metronome.everPlayed) {
                    startMetronome();
                }
            } else if (transcript === 'stop') {
                if (metronome.isPlaying) {
                    stopMetronome();
                }
            } else {
                const number = parseInt(transcript);

                if (!isNaN(number) && number >= 10 && number <= 400) {
                    metronome.setTempo(number);
                    statusElement.textContent = `Tempo set to ${number} BPM `;
                }
            }
        }
    };

    recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        listeningIndicator.classList.add('error');
        if (event.error === 'not-allowed') {
            statusElement.textContent = 'Please allow microphone access ';
            statusElement.appendChild(listeningIndicator);
        }
    };

    let wakeLock = null;

    const requestWakeLock = async () => {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener('release', () => {
            });
        } catch (err) {
            console.error(`${err.name}, ${err.message}`);
        }
    };

    if ('wakeLock' in navigator) {
        window.addEventListener('load', requestWakeLock);

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                requestWakeLock();
            }
        });
    }

</script>
</body>

</html>
